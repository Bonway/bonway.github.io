<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #f0f0f0; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="iOS源码解析," />





  <link rel="alternate" href="/atom.xml" title="Bonway" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.2" />






<meta name="description" content="介绍github地址：https://github.com/rs/SDWebImage
简介一个异步图片下载及缓存的库
特性：
一个扩展UIImageView分类的库，支持加载网络图片并缓存图片
异步图片下载器
异步图片缓存和自动图片有效期管理
支持GIF动态图片
支持WebP
背景图片减压
保证同一个URL不会再次下载
保证无效的URL不会重新加载
保证主线程不会死锁
性能优越
使用GCD和AR">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS SDWebImage源码解析（详解）">
<meta property="og:url" content="http://yoursite.com/2016/03/11/iOS SDWebImage源码解析（详解）/index.html">
<meta property="og:site_name" content="Bonway">
<meta property="og:description" content="介绍github地址：https://github.com/rs/SDWebImage
简介一个异步图片下载及缓存的库
特性：
一个扩展UIImageView分类的库，支持加载网络图片并缓存图片
异步图片下载器
异步图片缓存和自动图片有效期管理
支持GIF动态图片
支持WebP
背景图片减压
保证同一个URL不会再次下载
保证无效的URL不会重新加载
保证主线程不会死锁
性能优越
使用GCD和AR">
<meta property="og:updated_time" content="2018-03-14T08:55:15.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS SDWebImage源码解析（详解）">
<meta name="twitter:description" content="介绍github地址：https://github.com/rs/SDWebImage
简介一个异步图片下载及缓存的库
特性：
一个扩展UIImageView分类的库，支持加载网络图片并缓存图片
异步图片下载器
异步图片缓存和自动图片有效期管理
支持GIF动态图片
支持WebP
背景图片减压
保证同一个URL不会再次下载
保证无效的URL不会重新加载
保证主线程不会死锁
性能优越
使用GCD和AR">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2016/03/11/iOS SDWebImage源码解析（详解）/"/>





  <title>iOS SDWebImage源码解析（详解） | Bonway</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?da99a021876cb72e63bbf0f27d367af7";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <a href="http://blog.linqipuzi.com"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Bonway</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/03/11/iOS SDWebImage源码解析（详解）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Bonway">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mine.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Bonway">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">iOS SDWebImage源码解析（详解）</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-03-11T09:51:43+08:00">
                2016-03-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS进阶/" itemprop="url" rel="index">
                    <span itemprop="name">iOS进阶</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2016/03/11/iOS SDWebImage源码解析（详解）/#SOHUCS" itemprop="discussionUrl">
                  <span id="changyan_count_unit" class="post-comments-count hc-comment-count" data-xid="2016/03/11/iOS SDWebImage源码解析（详解）/" itemprop="commentsCount"></span>
                </a>
              
            
          

          
          
             <span id="/2016/03/11/iOS SDWebImage源码解析（详解）/" class="leancloud_visitors" data-flag-title="iOS SDWebImage源码解析（详解）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><h4 id="github地址："><a href="#github地址：" class="headerlink" title="github地址："></a>github地址：</h4><p><a href="https://github.com/rs/SDWebImage" target="_blank" rel="external">https://github.com/rs/SDWebImage</a></p>
<h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>一个异步图片下载及缓存的库</p>
<h4 id="特性："><a href="#特性：" class="headerlink" title="特性："></a>特性：</h4><ul>
<li>一个扩展UIImageView分类的库，支持加载网络图片并缓存图片</li>
<li>异步图片下载器</li>
<li>异步图片缓存和自动图片有效期管理</li>
<li>支持GIF动态图片</li>
<li>支持WebP</li>
<li>背景图片减压</li>
<li>保证同一个URL不会再次下载</li>
<li>保证无效的URL不会重新加载</li>
<li>保证主线程不会死锁</li>
<li>性能优越</li>
<li>使用GCD和ARC</li>
<li>支持ARM64位处理器</li>
</ul>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><ul>
<li>3.0后不再支持5.1.1</li>
<li>支持Cocoapods</li>
<li>用法不说了 github上有，挺简单的</li>
</ul>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>只要有图片的url，就能下载到图片，使用SDWebImage的好处就是缓存机制，每次取图片先判断是否在内存中，再到缓存中查找，找到了直接加载，在缓存中找不到才重新下载，url也会记录，是否是失效的url，是则不会再尝试。下载到的图片会缓存，用于下次可以直接加载。图片下载，解码，转换都异步进行，不会阻塞主线程。</p>
<h2 id="类的作用"><a href="#类的作用" class="headerlink" title="类的作用"></a>类的作用</h2><blockquote>
<h5 id="SDImageCache"><a href="#SDImageCache" class="headerlink" title="SDImageCache"></a>SDImageCache</h5><p>设置缓存的类型，方式，路径等</p>
<h5 id="SDWebImageCompat"><a href="#SDWebImageCompat" class="headerlink" title="SDWebImageCompat"></a>SDWebImageCompat</h5><p>兼容类，定义了很多宏和一个转换图片的方法</p>
<h5 id="SDWebImageDecoder"><a href="#SDWebImageDecoder" class="headerlink" title="SDWebImageDecoder"></a>SDWebImageDecoder</h5><p>解码器，让图片色彩转换（涉及到color space）</p>
<h5 id="SDWebImageDownloader"><a href="#SDWebImageDownloader" class="headerlink" title="SDWebImageDownloader"></a>SDWebImageDownloader</h5><p>下载器，设置下载相关，要用到SDWebImageDownloaderOperation</p>
<h5 id="SDWebImageDownloaderOperation"><a href="#SDWebImageDownloaderOperation" class="headerlink" title="SDWebImageDownloaderOperation"></a>SDWebImageDownloaderOperation</h5><p>下载器的操作</p>
<h5 id="SDWebImageManager"><a href="#SDWebImageManager" class="headerlink" title="SDWebImageManager"></a>SDWebImageManager</h5><p>管理图片下载，取消操作，判断url是否已缓存等</p>
<h5 id="SDWebImageOperation"><a href="#SDWebImageOperation" class="headerlink" title="SDWebImageOperation"></a>SDWebImageOperation</h5><p>图片操作，后面很多类都要用到</p>
<h5 id="SDWebImagePrefetcher"><a href="#SDWebImagePrefetcher" class="headerlink" title="SDWebImagePrefetcher"></a>SDWebImagePrefetcher</h5><p>预抓取器，预先下载urls中的图片</p>
<h5 id="UIButton-WebCache"><a href="#UIButton-WebCache" class="headerlink" title="UIButton+WebCache"></a>UIButton+WebCache</h5><p>按钮图片的缓存</p>
<h5 id="UIImage-GIF"><a href="#UIImage-GIF" class="headerlink" title="UIImage+GIF"></a>UIImage+GIF</h5><p>缓存gif</p>
<h5 id="NSData-ImageContentType"><a href="#NSData-ImageContentType" class="headerlink" title="NSData+ImageContentType"></a>NSData+ImageContentType</h5><p>判断图片的类型,png/jpeg/gif/webp</p>
<h5 id="UIImage-MultiFormat"><a href="#UIImage-MultiFormat" class="headerlink" title="UIImage+MultiFormat"></a>UIImage+MultiFormat</h5><p>缓存多种格式的图片，要用到NSData+ImageContentType的判断图片类型方法和UIImage+GIF的判断是否为gif图片方法，以及ImageIO里面的方法</p>
<h5 id="UIImageView-HighlightedWebCache"><a href="#UIImageView-HighlightedWebCache" class="headerlink" title="UIImageView+HighlightedWebCache"></a>UIImageView+HighlightedWebCache</h5><p>缓存高亮图片</p>
<h5 id="UIImageView-WebCache"><a href="#UIImageView-WebCache" class="headerlink" title="UIImageView+WebCache"></a>UIImageView+WebCache</h5><p>主要用到这个，加载及缓存UIImageView的图片</p>
<h5 id="UIView-WebCacheOperation"><a href="#UIView-WebCacheOperation" class="headerlink" title="UIView+WebCacheOperation"></a>UIView+WebCacheOperation</h5><p>缓存的操作，有缓存，取消操作，移除缓存</p>
</blockquote>
<h2 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h2><p>先讲一些比较边缘的方法</p>
<h4 id="0-SDWebImageOperation"><a href="#0-SDWebImageOperation" class="headerlink" title="0.SDWebImageOperation"></a>0.SDWebImageOperation</h4><p>图片操作，只有头文件，定义了协议SDWebImageOperation，里面也只有取消方法<br>这个类后面很多类都要用到。</p>
<p><code>@protocol SDWebImageOperation &lt;NSObject&gt;</code></p>
<p><code>- (void)cancel;</code></p>
<p><code>@end</code></p>
<h4 id="1-NSData-ImageContentType"><a href="#1-NSData-ImageContentType" class="headerlink" title="1.NSData+ImageContentType"></a>1.NSData+ImageContentType</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">这个文件是NSData的分类，只有一个方法，传入图片数据，根据图片的头标识来确定图片的类型。头标识都不一样，只需获取文件头字节，对比十六进制信息，判断即可。</div></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>图片文件</th>
<th>头标识</th>
<th>十六进制头字节</th>
</tr>
</thead>
<tbody>
<tr>
<td>jpeg/jpg</td>
<td>FFD8</td>
<td>0xFF</td>
</tr>
<tr>
<td>png</td>
<td>8950</td>
<td>0x89</td>
</tr>
<tr>
<td>gif</td>
<td>4749</td>
<td>0x47</td>
</tr>
<tr>
<td>tiff</td>
<td>4D4D / 4949</td>
<td>0x49/0x4D</td>
</tr>
</tbody>
</table>
<p>Webp格式开头是0x52，但是还有可能是其他类型文件，所以要识别前缀为<br>52 49 46 46 对应 RIFF<br>后缀 57 45 42 50 对应 WEBP，符合这些条件的才是webp图片文件</p>
<p><code>+ (NSString*)sd_contentTypeForImageData:(NSData *)data {</code></p>
<p><code>uint8_t c;</code></p>
<p><code>[data getBytes:&amp;c length:1];</code></p>
<p><code>switch(c) {</code></p>
<p><code>case 0xFF:</code></p>
<p><code>return @&quot;image/jpeg&quot;;</code></p>
<p><code>case 0x89:</code></p>
<p><code>return @&quot;image/png&quot;``;</code></p>
<p><code>case</code> <code>0x47:</code></p>
<p><code>return</code> <code>@``&quot;image/gif&quot;;</code></p>
<p><code>case 0x49:</code></p>
<p><code>case 0x4D:</code></p>
<p><code>return @&quot;image/tiff&quot;;</code></p>
<p><code>case 0x52:</code></p>
<p><code>// R as RIFF for WEBP</code></p>
<p><code>if ([data length] &lt; 12) {</code></p>
<p><code>return nil;</code></p>
<p><code>}</code></p>
<p><code>NSString *testString = [[NSString alloc] initWithData:[data subdataWithRange:NSMakeRange(0, 12)] encoding:NSASCIIStringEncoding];</code></p>
<p><code>if ([testString hasPrefix:@&quot;RIFF&quot;] &amp;&amp; [testString hasSuffix:@&quot;WEBP&quot;]) {</code></p>
<p><code>return @&quot;image/webp&quot;;</code></p>
<p><code>}</code></p>
<p><code>return nil;</code></p>
<p><code>}</code></p>
<p><code>return</code> <code>nil``;</code></p>
<p><code>}</code></p>
<hr>
<h4 id="2-SDWebImageCompat"><a href="#2-SDWebImageCompat" class="headerlink" title="2.SDWebImageCompat"></a>2.SDWebImageCompat</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">兼容类，这个类定义了很多宏还有一个伸缩图片的方法，宏就不说了</div></pre></td></tr></table></figure>
<p>这个方法定义成C语言式的内联方法<br>核心代码如下，传入key和图片，如果key中出现@2x就设定scale为2.0,出现@3x就设定scale为3.0，然后伸缩图片</p>
<p><code>CGFloat scale = [UIScreen mainScreen].scale;</code></p>
<p><code>if (key.length &gt;= 8) {</code></p>
<p><code>NSRange</code> <code>range = [key rangeOfString:@&quot;@2x.&quot;];</code></p>
<p><code>if (range.location != NSNotFound) {</code></p>
<p><code>scale = 2.0;</code></p>
<p><code>}</code></p>
<p><code>range = [key rangeOfString:@&quot;@3x.&quot;];</code></p>
<p><code>if (range.location != NSNotFound) {</code></p>
<p><code>scale = 3.0;</code></p>
<p><code>}</code></p>
<p><code>}</code></p>
<p><code>UIImage *scaledImage = [[UIImage alloc] initWithCGImage:image.CGImage scale:scale orientation:image.imageOrientation];</code></p>
<p><code>image = scaledImage;</code></p>
<hr>
<h5 id="3-SDWebImageDecoder"><a href="#3-SDWebImageDecoder" class="headerlink" title="3.SDWebImageDecoder"></a>3.SDWebImageDecoder</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">这个是解码器类，只定义了一个解码方法，传入图片，返回的也是图片</div></pre></td></tr></table></figure>
<p>CGImageRef是一个指针类型。typedef struct CGImage *CGImageRef;<br>获取传入图片的alpha信息，然后判断是否符合苹果定义的CGImageAlphaInfo，如果是就返回原图片</p>
<p><code>CGImageRef imageRef = image.CGImage;</code></p>
<p><code>CGImageAlphaInfo alpha = CGImageGetAlphaInfo(imageRef);</code></p>
<p><code>BOOL anyAlpha = (alpha == kCGImageAlphaFirst || alpha == kCGImageAlphaLast || alpha == kCGImageAlphaPremultipliedFirst || alpha == kCGImageAlphaPremultipliedLast);</code></p>
<p><code>if (anyAlpha) { return image; }</code></p>
<p>然后获取图片的宽高和color space（指定颜色值如何解释），判断color space是否支持，不支持就转换为支持的模式（RGB)，再用图形上下文根据获得的信息画出来，释放掉创建的CG指针再返回图片 </p>
<p><code>size_t width = CGImageGetWidth(imageRef);</code></p>
<p><code>size_t height = CGImageGetHeight(imageRef);</code></p>
<p><code>// current</code></p>
<p><code>CGColorSpaceModel imageColorSpaceModel = CGColorSpaceGetModel(CGImageGetColorSpace(imageRef));</code></p>
<p><code>CGColorSpaceRef colorspaceRef = CGImageGetColorSpace(imageRef);</code></p>
<p><code>bool</code> <code>unsupportedColorSpace = (imageColorSpaceModel == 0 || imageColorSpaceModel == -1 || imageColorSpaceModel == kCGColorSpaceModelCMYK || imageColorSpaceModel == kCGColorSpaceModelIndexed);</code></p>
<p><code>if</code> <code>(unsupportedColorSpace)</code></p>
<p><code>colorspaceRef = CGColorSpaceCreateDeviceRGB();</code></p>
<p><code>CGContextRef context = CGBitmapContextCreate(``NULL``, width,</code></p>
<p><code>height,</code></p>
<p><code>CGImageGetBitsPerComponent(imageRef),</code></p>
<p><code>0,</code></p>
<p><code>colorspaceRef,</code></p>
<p><code>kCGBitmapByteOrderDefault | kCGImageAlphaPremultipliedFirst);</code></p>
<p><code>CGContextDrawImage(context, CGRectMake(0, 0, width, height), imageRef);</code></p>
<p><code>CGImageRef imageRefWithAlpha = CGBitmapContextCreateImage(context);</code></p>
<p><code>UIImage *imageWithAlpha = [UIImage imageWithCGImage:imageRefWithAlpha scale:image.scale orientation:image.imageOrientation];</code></p>
<p><code>if</code> <code>(unsupportedColorSpace)</code></p>
<p><code>CGColorSpaceRelease(colorspaceRef);</code></p>
<p><code>CGContextRelease(context);</code></p>
<p><code>CGImageRelease(imageRefWithAlpha);</code></p>
<p><code>return</code> <code>imageWithAlpha;</code></p>
<hr>
<p>这个算是核心部分</p>
<h4 id="4-UIView-WebCacheOperation"><a href="#4-UIView-WebCacheOperation" class="headerlink" title="4.UIView+WebCacheOperation"></a>4.UIView+WebCacheOperation</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">缓存操作的UIView的分类，支持三种操作，也是整个库中比较核心的操作</div></pre></td></tr></table></figure>
<p>但是首先我们来了解三种操作都要用到的存储数据的方法。<br>这两个方法用的是OC中runtime方法，原理是两个文件关联方法，和上层的存储方法差不多，传入value和key对应，取出也是根据key取出value<br>object传入self即可</p>
<h5 id="1-设置关联方法"><a href="#1-设置关联方法" class="headerlink" title="1.设置关联方法"></a>1.设置关联方法</h5><p><code>//传入object和key和value，policy</code></p>
<p><code>//policy即存储方式，和声明使用几种属性大致相同，有copy,retain,copy,retain_nonatomic,assign 五种）</code></p>
<p><code>void</code> <code>objc_setAssociatedObject(``id</code> <code>object, ``const</code> <code>void</code> <code>*key, ``id</code> <code>value, objc_AssociationPolicy policy)</code></p>
<h5 id="2-取出方法"><a href="#2-取出方法" class="headerlink" title="2.取出方法"></a>2.取出方法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//传入object和key返回value</div><div class="line">id objc_getAssociatedObject(id object, const void *key)</div></pre></td></tr></table></figure>
<p>这个方法是三种操作都要用到的，获得数据<br>这个方法是使用前面两个方法，根据缓存加载数据<br>有缓存则从缓存中取出数据，没有则缓存数据，返回格式是字典格式 </p>
<p><code>- (NSMutableDictionary*)operationDictionary {</code></p>
<p><code>NSMutableDictionary *operations = objc_getAssociatedObject(self``, &amp;loadOperationKey);</code></p>
<p><code>if (operations) {</code></p>
<p><code>return operations;</code></p>
<p><code>}</code></p>
<p><code>operations = [ NSMutableDictionary dictionary];</code></p>
<p><code>objc_setAssociatedObject( self, &amp;loadOperationKey, operations, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</code></p>
<p><code>return</code> <code>operations;</code></p>
<p><code>}</code></p>
<p>接下来是三种操作</p>
<h5 id="一-加载图片根据是否有缓存"><a href="#一-加载图片根据是否有缓存" class="headerlink" title="一.加载图片根据是否有缓存"></a>一.加载图片根据是否有缓存</h5><p>从获得数据方法获得数据，传入key，先调用第二个方法停止操作，再根据key缓存数据</p>
<p><code>- (void)sd_setImageLoadOperation:(id)operation forKey:(NSString *)key {</code></p>
<p><code>[self sd_cancelImageLoadOperationWithKey:key];</code></p>
<p><code>NSMutableDictionary</code> <code>*operationDictionary = [``self</code> <code>operationDictionary];</code></p>
<p><code>[operationDictionary setObject:operation forKey:key];</code></p>
<p><code>}</code></p>
<pre style="margin: 0px; padding: 0px; white-space: pre-wrap; word-wrap: break-word; color: rgb(57, 57, 57); font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(250, 247, 239); text-decoration-style: initial; text-decoration-color: initial;">二.取消加载图片如果有缓存</pre>

<p>先获得方法一的返回字典数据，传入key在返回的字典中查找是否已经存在，如果存在则取消所有操作<br>conformsToProtocol方法如果符合这个协议（协议中声明了取消方法），调用协议中的取消方法</p>
<p><code>- (void)sd_cancelImageLoadOperationWithKey:(NSString *)key {</code></p>
<p><code>// Cancel in progress downloader from queue</code></p>
<p><code>NSMutableDictionary</code> <code>*operationDictionary = [self operationDictionary];</code></p>
<p><code>id operations = [operationDictionary objectForKey:key];</code></p>
<p><code>if</code> <code>(operations) {</code></p>
<p><code>if ([operations isKindOfClass:[ NSArray class ]]) {</code></p>
<p><code>for ( id &lt;SDWebImageOperation&gt; operation in operations) {</code></p>
<p><code>if (operation) {</code></p>
<p><code>[operation cancel];</code></p>
<p><code>}</code></p>
<p><code>}</code></p>
<p><code>}  else if ([operations conformsToProtocol: @protocol (SDWebImageOperation)]){</code></p>
<p><code>[( id &lt;SDWebImageOperation&gt;) operations cancel];</code></p>
<p><code>}</code></p>
<p><code>[operationDictionary removeObjectForKey:key];</code></p>
<p><code>}</code></p>
<p><code>}</code></p>
<h5 id="三-移除缓存"><a href="#三-移除缓存" class="headerlink" title="三.移除缓存"></a>三.移除缓存</h5><p>获得方法一的数据，传入key如果key对应的数据在数据中则移除 </p>
<p><code>- ( void )sd_removeImageLoadOperationWithKey:( NSString *)key {</code></p>
<p><code>NSMutableDictionary *operationDictionary = [ self operationDictionary];</code></p>
<p><code>[operationDictionary removeObjectForKey:key];</code></p>
<p><code>}</code></p>
<hr>
<h4 id="5-SDWebImageDownloader"><a href="#5-SDWebImageDownloader" class="headerlink" title="5.SDWebImageDownloader"></a>5.SDWebImageDownloader</h4><p>下载器类，需要用到SDWebImageDownloaderOperation类，下载器操作，后面会说到</p>
<p>定义了一些属性 </p>
<p><code>//下载队列的最大下载数</code></p>
<p><code>@property ( assign,  nonatomic )  NSInteger maxConcurrentDownloads;</code></p>
<p><code>//当前下载数</code></p>
<p><code>@property ( readonly ,  nonatomic )  NSUInteger currentDownloadCount;</code></p>
<p><code>//下载超时的时间</code></p>
<p><code>@property (assign,  nonatomic )  NSTimeInterval downloadTimeout;</code></p>
<p><code>//是否解压图片，默认是</code></p>
<p><code>@property (assign,  nonatomic )  BOOL shouldDecompressImages;</code></p>
<p><code>//下载器顺序，枚举类型，有两种，先进先出，还是后进先出</code></p>
<p><code>@property (assign,  nonatomic ) SDWebImageDownloaderExecutionOrder executionOrder;</code></p>
<p><code>#####还有一些用户属性</code></p>
<p><code>//url证书</code></p>
<p><code>@property (strong,  nonatomic )  NSURLCredential *urlCredential;</code></p>
<p><code>//用户名</code></p>
<p><code>@property (strong,  nonatomic )  NSString *username;</code></p>
<p><code>//密码</code></p>
<p><code>@property (strong,  nonatomic )  NSString *password;</code></p>
<p><code>//头像过滤器，block指针类型，接受url和字典headers</code></p>
<p><code>@property (nonatomic ,  copy ) SDWebImageDownloaderHeadersFilterBlock headersFilter;</code></p>
<h5 id="init方法"><a href="#init方法" class="headerlink" title="init方法"></a>init方法</h5><p>初始化了一些属性和写好http请求头 </p>
<p><code>- (id)init {</code></p>
<p><code>if ((self = [ super init])) {</code></p>
<p><code>_operationClass = [SDWebImageDownloaderOperation  class ];</code></p>
<p><code>_shouldDecompressImages = YES;</code></p>
<p><code>_executionOrder = SDWebImageDownloaderFIFOExecutionOrder;</code></p>
<p><code>_downloadQueue = [ NSOperationQueue new ];</code></p>
<p><code>_downloadQueue.maxConcurrentOperationCount = 6;</code></p>
<p><code>_URLCallbacks = [ NSMutableDictionary new ];</code></p>
<p><code>#ifdef SD_WEBP</code></p>
<p><code>_HTTPHeaders = [@{@ &quot;Accept&quot; : @ &quot;image/webp,image/*;q=0.8&quot; } mutableCopy];</code></p>
<p><code>#else</code></p>
<p><code>_HTTPHeaders = [@{@``&quot;Accept&quot;``: @``&quot;image/*;q=0.8&quot;``} mutableCopy];</code></p>
<p><code>#endif</code></p>
<p><code>_barrierQueue = dispatch_queue_create( &quot;com.hackemist.SDWebImageDownloaderBarrierQueue&quot;, DISPATCH_QUEUE_CONCURRENT);</code></p>
<p><code>_downloadTimeout = 15.0;</code></p>
<p><code>}</code></p>
<p><code>return self</code> ;`</p>
<p><code>}</code></p>
<h5 id="核心方法"><a href="#核心方法" class="headerlink" title="核心方法"></a>核心方法</h5><p>传入url，下载器选项（接下来会说），进度block，完成回调block</p>
<p><code>- ( id &lt;SDWebImageOperation&gt;)downloadImageWithURL:( NSURL *)url</code></p>
<p><code>options:(SDWebImageDownloaderOptions)options</code></p>
<p><code>progress:(SDWebImageDownloaderProgressBlock)progressBlock</code></p>
<p><code>completed:(SDWebImageDownloaderCompletedBlock)completedBlock;</code></p>
<p>这个方法非常复杂，定义了http请求，定义了SDWebImageDownloaderOperation实例，即下载器操作，初始化过程非常复杂，用到了http请求，用到了前面定义的那些属性，最后返回这个操作，这个过程建议去看源码</p>
<hr>
<h4 id="6-SDWebImageDownloaderOperation"><a href="#6-SDWebImageDownloaderOperation" class="headerlink" title="6.SDWebImageDownloaderOperation"></a>6.SDWebImageDownloaderOperation</h4><p>下载器的操作<br>直接看前面下载器需要用到的初始化方法<br>需要初始化了各种属性，主要是几个block，进度block，完成回调block，取消回调block </p>
<p><code>- (id)initWithRequest:(NSURLRequest*) request</code></p>
<p><code>options:(SDWebImageDownloaderOptions)options</code></p>
<p><code>progress:(SDWebImageDownloaderProgressBlock)progressBlock</code></p>
<p><code>completed:(SDWebImageDownloaderCompletedBlock)completedBlock</code></p>
<p><code>cancelled:(SDWebImageNoParamsBlock)cancelBlock {</code></p>
<p><code>if (( self = [ super init])) {</code></p>
<p><code>_request = request;</code></p>
<p><code>_shouldDecompressImages = YES ;</code></p>
<p><code>_shouldUseCredentialStorage = YES ;</code></p>
<p><code>_options = options;</code></p>
<p><code>_progressBlock = [progressBlock  copy ];</code></p>
<p><code>_completedBlock = [completedBlock copy ];</code></p>
<p><code>_cancelBlock = [cancelBlock copy ];</code></p>
<p><code>_executing = NO ;</code></p>
<p><code>_finished =  NO ;</code></p>
<p><code>_expectedSize = 0;</code></p>
<p><code>responseFromCached = YES ;</code></p>
<p><code>}</code></p>
<p><code>return self ;</code></p>
<p><code>}</code></p>
<p> |</p>
<hr>
<h4 id="7-SDWebImageManager"><a href="#7-SDWebImageManager" class="headerlink" title="7.SDWebImageManager"></a>7.SDWebImageManager</h4><p>图片管理器，负责图片的下载，转换，缓存等<br>这里先说明SDWebImageOptions<br>1 &lt;&lt; X 这种是位运算符，1左移多少位，后面要用到，说明一下 </p>
<p><code>typedef</code> <code>NS_OPTIONS``(``NSUInteger``, SDWebImageOptions) {</code></p>
<p><code>SDWebImageRetryFailed = 1 &lt;&lt; 0， //无效url会加入黑名单，这个标志是禁用黑名单</code></p>
<p><code>SDWebImageLowPriority = 1 &lt;&lt; 1,  //低优先级，会后下载</code></p>
<p><code>SDWebImageCacheMemoryOnly = 1 &lt;&lt; 2,  //禁用磁盘缓存</code></p>
<p><code>SDWebImageProgressiveDownload = 1 &lt;&lt; 3,  //显示下载进度，下载完才显示</code></p>
<p><code>SDWebImageRefreshCached = 1 &lt;&lt; 4, //重新从远程缓存</code></p>
<p><code>SDWebImageContinueInBackground = 1 &lt;&lt; 5, ``//在后台继续下载图片</code></p>
<p><code>SDWebImageHandleCookies = 1 &lt;&lt; 6,  //把cookie存储到NSHTTPCookieStorey</code></p>
<p><code>SDWebImageAllowInvalidSSLCertificates = 1 &lt;&lt; 7,  //允许非信任ssl证书</code></p>
<p><code>SDWebImageHighPriority = 1 &lt;&lt; 8,  //高优先级，插队下载队列</code></p>
<p><code>SDWebImageDelayPlaceholder = 1 &lt;&lt; 9,  //显示的是替代图片(初始化图片)</code></p>
<p><code>SDWebImageTransformAnimatedImage = 1 &lt;&lt; 10,  //转换图片大小</code></p>
<p><code>SDWebImageAvoidAutoSetImage = 1 &lt;&lt; 11  //避免自动设置图片（想手动的时候设置)</code></p>
<p><code>};</code></p>
<p>这里包含了各种选择</p>
<p>核心方法<br>传入url，上面的options，进度block，完成回调block</p>
<p><code>- ( id &lt;SDWebImageOperation&gt;)downloadImageWithURL:( NSURL *)url</code></p>
<p><code>options:(SDWebImageOptions)options</code></p>
<p><code>progress:(SDWebImageDownloaderProgressBlock)progressBlock</code></p>
<p><code>​completed:(SDWebImageCompletionWithFinishedBlock)completedBlock;</code></p>
<p>实例化过程请去看源码</p>
<p>说下其他方法<br>一个传入key判断图片是否存在存储空间的方法<br>使用的是NSFileManager的方法</p>
<p><code>- (``BOOL``)diskImageExistsWithKey:(``NSString</code> <code>*)key {</code></p>
<p><code>BOOL exists = NO;</code></p>
<p><code>exists = [[ NSFileManager defaultManager] fileExistsAtPath:[self defaultCachePathForKey:key]];</code></p>
<p><code>if (!exists) {</code></p>
<p><code>exists = [[ NSFileManager defaultManager] fileExistsAtPath:[[ self defaultCachePathForKey:key] stringByDeletingPathExtension]];</code></p>
<p><code>}</code></p>
<p><code>return exists;</code></p>
<p><code>}</code></p>
<p>还有从存储空间或者缓存取出图片的方法<br>self.memCache是AutoPurgeCache（单纯继承自NSCache）的实例<br>从存储空间取图片要先判断内存中是否存在，然后才从存储空间中查找<br><code>- (UIImage *)imageFromMemoryCacheForKey:(``NSString</code> <code>*)key {</code></p>
<p><code>return [ self .memCache objectForKey:key];</code></p>
<p><code>}</code></p>
<p><code>- (UIImage *)imageFromDiskCacheForKey:( NSString *)key {</code></p>
<p><code>UIImage *image = [ self imageFromMemoryCacheForKey:key];</code></p>
<p><code>if (image) {</code></p>
<p><code>return image;</code></p>
<p><code>}</code></p>
<p><code>UIImage *diskImage = [ self diskImageForKey:key];</code></p>
<p><code>if (diskImage &amp;&amp;  self .shouldCacheImagesInMemory) {</code></p>
<p><code>NSUInteger cost = SDCacheCostForImage(diskImage);</code></p>
<p><code>[ self .memCache setObject:diskImage forKey:key cost:cost];</code></p>
<p><code>}</code></p>
<p><code>return diskImage;</code></p>
<p><code>}</code></p>
<p><code>- (UIImage *)diskImageForKey:( NSString *)key {</code></p>
<p><code>NSData *data = [ self diskImageDataBySearchingAllPathsForKey:key];</code></p>
<p><code>if</code> <code>(data) {</code></p>
<p><code>UIImage *image = [UIImage sd_imageWithData:data];</code></p>
<p><code>image = [ self scaledImageForKey:key image:image];</code></p>
<p><code>if</code> <code>( self .shouldDecompressImages) {</code></p>
<p><code>image = [UIImage decodedImageWithImage:image];</code></p>
<p><code>}</code></p>
<p><code>return image;</code></p>
<p><code>}</code></p>
<p><code>else {</code></p>
<p><code>return nil ;</code></p>
<p><code>}</code></p>
<p><code>}</code></p>
<p>还有几个清除方法<br><code>- ( void )clearDisk;</code></p>
<p><code>- ( void )clearMemory;</code></p>
<p><code>- ( void )cleanDisk;</code></p>
<p><code>- ( void )cleanDiskWithCompletionBlock;</code></p>
<p><code>...</code></p>
<hr>
<h4 id="8-SDWebImagePrefetcher"><a href="#8-SDWebImagePrefetcher" class="headerlink" title="8.SDWebImagePrefetcher"></a>8.SDWebImagePrefetcher</h4><p>预抓取器，用来预抓取图片<br>核心方法 </p>
<p><code>//预抓取图片</code></p>
<p><code>- (void)prefetchURLs:( NSArray *)urls progress:(SDWebImagePrefetcherProgressBlock)progressBlock completed:(SDWebImagePrefetcherCompletionBlock)completionBlock;</code></p>
<p><code>//取消预抓取图片</code></p>
<p><code>- ( void )cancelPrefetching;</code></p>
<p>先来看预抓取图片<br>传入url，进度block，完成回调block<br>首先取消抓取，然后重新开始</p>
<p><code>- (void)prefetchURLs:( NSArray *)urls progress:(SDWebImagePrefetcherProgressBlock)progressBlock completed:(SDWebImagePrefetcherCompletionBlock)completionBlock {</code></p>
<p><code>[ self cancelPrefetching]; // Prevent duplicate prefetch request</code></p>
<p><code>self .startedTime = CFAbsoluteTimeGetCurrent();</code></p>
<p><code>self .prefetchURLs = urls;</code></p>
<p><code>self .completionBlock = completionBlock;</code></p>
<p><code>self .progressBlock = progressBlock;</code></p>
<p><code>if (urls.count == 0) {</code></p>
<p><code>if (completionBlock) {</code></p>
<p><code>completionBlock(0,0);</code></p>
<p><code>}</code></p>
<p><code>} else {</code></p>
<p><code>NSUInteger listCount =  self .prefetchURLs.count;</code></p>
<p><code>for ( NSUInteger i = 0; i &lt; self .maxConcurrentDownloads &amp;&amp;  self .requestedCount &lt; listCount; i++) {</code></p>
<p><code>[ self startPrefetchingAtIndex:i];</code></p>
<p><code>}</code></p>
<p><code>}</code></p>
<p><code>}</code><br>最后调用startPrefetchingAtIndex:方法，再调用self.manager的核心方法，即开始下载图片 </p>
<p><code>- ( id &lt;SDWebImageOperation&gt;)downloadImageWithURL:( NSURL *)url</code></p>
<p><code>options:(SDWebImageOptions)options</code></p>
<p><code>progress:(SDWebImageDownloaderProgressBlock)progressBlock</code></p>
<p><code>completed:(SDWebImageCompletionWithFinishedBlock)completedBlock;</code></p>
<hr>
<p>最后是各种分类，即直接再初始化的控件设置图片，支持UIButton，UIImage,UIImageView，大同小异，我直接说UIImageView+WebCache</p>
<h4 id="9-UIImageView-WebCache"><a href="#9-UIImageView-WebCache" class="headerlink" title="9.UIImageView+WebCache"></a>9.UIImageView+WebCache</h4><p>很多加载方法最终都会以缺省参数方式或者直接调用这个方法，传入一个URL，一个用来初始化的image，一个options（枚举，下面详细说明），一个progressBlock（返回图片接受进度等），一个completedBlock（完成回调block） </p>
<p><code>- (void)sd_setImageWithURL:(NSURL*)url placeholderImage:(UIImage *)placeholder options:(SDWebImageOptions)options progress:(SDWebImageDownloaderProgressBlock)progressBlock completed:(SDWebImageCompletionBlock)completedBlock;</code></p>
<p>首先根据url缓存图片，这里用到的是OC的runtime中的关联方法（见4）</p>
<p><code>objc_setAssociatedObject(``self``, &amp;imageURLKey, url, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</code></p>
<p>然后判断options（见7）是其他选择则直接给图片赋值placehoder图片，这里判断使用的是 &amp; 与 位运算符，SDWebImageDelayPlacehoder是 1 &lt;&lt; 9，1左移9位与options相与<br><code>if (!(options &amp; SDWebImageDelayPlaceholder)) {</code></p>
<p><code>dispatch_main_async_safe(^{</code></p>
<p><code>self``.image = placeholder;</code></p>
<p><code>});</code></p>
<p><code>}</code></p>
<p>如果url存在，则定义图片操作，使用图片管理器的单例来调用核心方法（下载图片方法）</p>
<p><code>id</code> <code>&lt;SDWebImageOperation&gt; operation = [SDWebImageManager.sharedManager downloadImageWithURL:url options:options progress:progressBlock completed:^(UIImage *image, ``NSError</code> <code>*error, SDImageCacheType cacheType, ``BOOL</code> <code>finished, ``NSURL</code> <code>*imageURL) {</code></p>
<p><code>//过程省略</code></p>
<p><code>}</code></p>
<hr>
<h4 id="10-UIImage-GIF"><a href="#10-UIImage-GIF" class="headerlink" title="10.UIImage+GIF"></a>10.UIImage+GIF</h4><p>gif的实现使用了ImageIO中的CGImageSourceRef<br>用获得的gif数据得到CGImageSourceRef，然后算出时间，在这个时间内把图片一帧一帧的放进一个数组，最后再把这个数组和时间转成图片，就成了gif</p>
<p><code>+ (UIImage *)sd_animatedGIFWithData:(``NSData</code> <code>*)data {</code></p>
<p><code>if</code> <code>(!data) {</code></p>
<p><code>return</code> <code>nil``;</code></p>
<p><code>}</code></p>
<p><code>CGImageSourceRef source = CGImageSourceCreateWithData((__bridge CFDataRef)data, ``NULL``);</code></p>
<p><code>size_t count = CGImageSourceGetCount(source);</code></p>
<p><code>UIImage *animatedImage;</code></p>
<p><code>if</code> <code>(count &lt;= 1) {</code></p>
<p><code>animatedImage = [[UIImage alloc] initWithData:data];</code></p>
<p><code>}</code></p>
<p><code>else</code> <code>{</code></p>
<p><code>NSMutableArray</code> <code>*images = [``NSMutableArray</code> <code>array];</code></p>
<p><code>NSTimeInterval</code> <code>duration = 0.0f;</code></p>
<p><code>for</code> <code>(size_t i = 0; i &lt; count; i++) {</code></p>
<p><code>CGImageRef image = CGImageSourceCreateImageAtIndex(source, i, ``NULL``);</code></p>
<p><code>duration += [``self</code> <code>sd_frameDurationAtIndex:i source:source];</code></p>
<p><code>[images addObject:[UIImage imageWithCGImage:image scale:[UIScreen mainScreen].scale orientation:UIImageOrientationUp]];</code></p>
<p><code>CGImageRelease(image);</code></p>
<p><code>}</code></p>
<p><code>if</code> <code>(!duration) {</code></p>
<p><code>duration = (1.0f / 10.0f) * count;</code></p>
<p><code>}</code></p>
<p><code>animatedImage = [UIImage animatedImageWithImages:images duration:duration];</code></p>
<p><code>}</code></p>
<p><code>CFRelease(source);</code></p>
<p><code>return</code> <code>animatedImage;</code></p>
<p><code>}</code></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>看完SDWebImage的源码后感觉学到了很多东西，特别是缓存那一块写的特别好。ImageIO和objc/runtime很值得学习一下。也感觉到设计出这样一个库需要很强大的知识面，非常严谨的思想，真的不容易。</p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpeg" alt="Bonway WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpeg" alt="Bonway Alipay"/>
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS源码解析/"  <i class="fa fa-tag"></i> iOS源码解析</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/03/10/iOS AFNetWorking源码解析（进阶）/" rel="next" title="iOS AFNetWorking源码解析（进阶）">
                <i class="fa fa-chevron-left"></i> iOS AFNetWorking源码解析（进阶）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/03/11/iOS中UIScrollView、UIWebView、UICollectionView实现图文混排/" rel="prev" title="iOS UIScrollView、UIWebView、UICollectionView实现图文混排">
                iOS UIScrollView、UIWebView、UICollectionView实现图文混排 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        
  <div class="bdsharebuttonbox">
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
    <a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a>
    <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
    <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a class="bds_count" data-cmd="count"></a>
  </div>
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "2",
        "bdMiniList": false,
        "bdPic": ""
      },
      "share": {
        "bdSize": "16",
        "bdStyle": "0"
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "分享到：",
        "viewSize": "16"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="SOHUCS"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/mine.png"
               alt="Bonway" />
          <p class="site-author-name" itemprop="name">Bonway</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">49</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="mailto:421817275@qq.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="tencent://421817275" target="_blank" title="QQ">
                  
                    <i class="fa fa-fw fa-qq"></i>
                  
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#介绍"><span class="nav-number">1.</span> <span class="nav-text">介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#github地址："><span class="nav-number">1.0.1.</span> <span class="nav-text">github地址：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#简介"><span class="nav-number">1.0.2.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#特性："><span class="nav-number">1.0.3.</span> <span class="nav-text">特性：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他"><span class="nav-number">1.0.4.</span> <span class="nav-text">其他</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#原理"><span class="nav-number">2.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#类的作用"><span class="nav-number">3.</span> <span class="nav-text">类的作用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SDImageCache"><span class="nav-number">3.0.0.1.</span> <span class="nav-text">SDImageCache</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SDWebImageCompat"><span class="nav-number">3.0.0.2.</span> <span class="nav-text">SDWebImageCompat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SDWebImageDecoder"><span class="nav-number">3.0.0.3.</span> <span class="nav-text">SDWebImageDecoder</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SDWebImageDownloader"><span class="nav-number">3.0.0.4.</span> <span class="nav-text">SDWebImageDownloader</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SDWebImageDownloaderOperation"><span class="nav-number">3.0.0.5.</span> <span class="nav-text">SDWebImageDownloaderOperation</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SDWebImageManager"><span class="nav-number">3.0.0.6.</span> <span class="nav-text">SDWebImageManager</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SDWebImageOperation"><span class="nav-number">3.0.0.7.</span> <span class="nav-text">SDWebImageOperation</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SDWebImagePrefetcher"><span class="nav-number">3.0.0.8.</span> <span class="nav-text">SDWebImagePrefetcher</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#UIButton-WebCache"><span class="nav-number">3.0.0.9.</span> <span class="nav-text">UIButton+WebCache</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#UIImage-GIF"><span class="nav-number">3.0.0.10.</span> <span class="nav-text">UIImage+GIF</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#NSData-ImageContentType"><span class="nav-number">3.0.0.11.</span> <span class="nav-text">NSData+ImageContentType</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#UIImage-MultiFormat"><span class="nav-number">3.0.0.12.</span> <span class="nav-text">UIImage+MultiFormat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#UIImageView-HighlightedWebCache"><span class="nav-number">3.0.0.13.</span> <span class="nav-text">UIImageView+HighlightedWebCache</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#UIImageView-WebCache"><span class="nav-number">3.0.0.14.</span> <span class="nav-text">UIImageView+WebCache</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#UIView-WebCacheOperation"><span class="nav-number">3.0.0.15.</span> <span class="nav-text">UIView+WebCacheOperation</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#源码解析"><span class="nav-number">4.</span> <span class="nav-text">源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#0-SDWebImageOperation"><span class="nav-number">4.0.1.</span> <span class="nav-text">0.SDWebImageOperation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-NSData-ImageContentType"><span class="nav-number">4.0.2.</span> <span class="nav-text">1.NSData+ImageContentType</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-SDWebImageCompat"><span class="nav-number">4.0.3.</span> <span class="nav-text">2.SDWebImageCompat</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-SDWebImageDecoder"><span class="nav-number">4.0.3.1.</span> <span class="nav-text">3.SDWebImageDecoder</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-UIView-WebCacheOperation"><span class="nav-number">4.0.4.</span> <span class="nav-text">4.UIView+WebCacheOperation</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-设置关联方法"><span class="nav-number">4.0.4.1.</span> <span class="nav-text">1.设置关联方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-取出方法"><span class="nav-number">4.0.4.2.</span> <span class="nav-text">2.取出方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#一-加载图片根据是否有缓存"><span class="nav-number">4.0.4.3.</span> <span class="nav-text">一.加载图片根据是否有缓存</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#三-移除缓存"><span class="nav-number">4.0.4.4.</span> <span class="nav-text">三.移除缓存</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-SDWebImageDownloader"><span class="nav-number">4.0.5.</span> <span class="nav-text">5.SDWebImageDownloader</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#init方法"><span class="nav-number">4.0.5.1.</span> <span class="nav-text">init方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#核心方法"><span class="nav-number">4.0.5.2.</span> <span class="nav-text">核心方法</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-SDWebImageDownloaderOperation"><span class="nav-number">4.0.6.</span> <span class="nav-text">6.SDWebImageDownloaderOperation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-SDWebImageManager"><span class="nav-number">4.0.7.</span> <span class="nav-text">7.SDWebImageManager</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-SDWebImagePrefetcher"><span class="nav-number">4.0.8.</span> <span class="nav-text">8.SDWebImagePrefetcher</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-UIImageView-WebCache"><span class="nav-number">4.0.9.</span> <span class="nav-text">9.UIImageView+WebCache</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-UIImage-GIF"><span class="nav-number">4.0.10.</span> <span class="nav-text">10.UIImage+GIF</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2014 - 
  <span itemprop="copyrightYear">2018</span>
  
  <span class="author" itemprop="copyrightHolder">Bonway</span>
</div>



Powered by <a href="http://blog.linqipuzi.com/" target="_blank">Bonway</a>
·浙ICP备18006992号 <a href="http://blog.linqipuzi.com/" target="_blank"></a>



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共字</span>
</div>

        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  




  
    <script type="text/javascript">
    (function(){
      var appid = 'cytrMgNxf';
      var conf = 'bc060e5ba4249731b1c8b8e92d032584';
      var width = window.innerWidth || document.documentElement.clientWidth;
      if (width < 960) {
      window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){
        window.changyan.api.config({appid:appid,conf:conf})});
      }
    })();
    </script>
    <script type="text/javascript" src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script>
  



  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("vSIGWaVuClR8KRBO8C13a5k0-gzGzoHsz", "snxTUFWhWzp3gYHYljaCIjAh");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

  


</body>
</html>

